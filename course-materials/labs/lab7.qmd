---
title: "Monarch Watch"
author: "Schwab"
format: html
editor: visual
---

```{r}
library(googlesheets4)
library(tidyverse)
library(janitor)
library(tidygeocoder)
library(sf)
```

Every year Monarch Butterflies fly south for the winter. They start in higher latitudes and migrate south to their wintering areas in Mexico.

[Monarch Watch](https://monarchwatch.org/blog/) is a citizen science initiative housed in the University of Kansas. Every year volunteers tag these butterflies and release them so their progress in their southern migration can be mapped. If someone finds a monarch with a tag they [can report it.](https://docs.google.com/forms/d/e/1FAIpQLSetTI4HYcyb1GfIyo-U5rAuVVezvOrwicz2ztIt244Vh7S4VA/viewform)

The reporting data is available online in the form of google sheets. It can be brought into R with the `googlesheets4` R package. Pay attention to your console, google needs permission to download.

```{r}
#install.packages("googlesheets4")

US_CAN_Recovery_2022 <- read_sheet("https://docs.google.com/spreadsheets/d/14ONbP-0rgvVz-DR0MWYkkPm0BzyFBHMiNCA2F5I8Yks/edit#gid=1710298744")

Pre_2023_Mexico_Recovery <- read_sheet("https://docs.google.com/spreadsheets/d/1UdJfooBJrm0Y1zlpwIhGz7ToZfP9h8OeucJbXrWwZEY/edit#gid=1853245517")

# The code below takes both of these dataframes and makes them into a list. 

data_frame_list <- list(US_CAN_Recovery_2022, Pre_2023_Mexico_Recovery)
```

There is an R object called a list. A list can store different types of objects like data frames, vectors, character values, etc.

List can be handy for storing and retrieving data. We will make a list called `butterfly_dataframes` and use it to do some data analysis.

```{r}
# We need to clean the data we downloaded form google sheets. We can use clean_names() to do this. Since there are two dataframes we can clean them both at once. Use map() to do so. 

# Iterate over your function to clean the names and store the three dataframes as a list. 
butterfly_dataframes <- map(
  .x = data_frame_list,
  .f = clean_names
)

# At the moment butterfly_dataframes is unnamed which is inconvient so below I'm naming all the dataframes in the list.  

names(butterfly_dataframes) <-   c( "US_CAN_Recovery_2022", "Pre_2023_Mexico_Recovery")
```

Now work with the list \`butterfly_dataframes\`

```{r}
# glimpse just one of the dataframes with $
# butterfly_dataframes$US_CAN_Recovery_2022

view(butterfly_dataframes$US_CAN_Recovery_2022)
```

I'd like to trace the paths of these butterflies on a map of the US.

Find the top 7 most spotted butterflies from 2021 and 2022

```{r}
top_7_most_spotted_2022 <- butterfly_dataframes$US_CAN_Recovery_2022  |>
  count(tag_code) |>
  arrange(desc(n)) |>
  slice_head(n=7) |>
  pull(tag_code)
  

```

Now we need the location data for the top 7 butterflies. You can do this with a `filter()`, piped into `select()` to get the location of the city and state and finally pipe that information into `geocode()`. It takes `geocode()` sometime to produce lat and long data. Make sure your filtering works as expected before using `geocode()`. We are getting the lat and long on the city level.

```{r}
top_7_butterfly <- butterfly_dataframes$US_CAN_Recovery_2022 |>
  filter(tag_code %in% top_7_most_spotted_2022) |>
  select(tag_code,city_location,state_province) |>
  geocode(city = city_location, state= state_province)
```

We need a map of the Canada, Mexico and the US together. We can get them from the maps package then create simple features with them.

```{r}
# Make a US state map and a Canada/Mexico Map

USA_map <-  maps::map("state", plot = FALSE, fill = TRUE) |> st_as_sf(coords = c("x", "y"), crs = 4326)

```

In the chunk below there is a plot of the map that the Political Boundaries shape file gives.

```{r}
ggplot()+
  geom_sf(data = USA_map) +
  theme_minimal() 
```

This is much better. In the code chunk below add your top 7 butterflies, be sure to jitter them.

```{r}
USA_map|>
  ggplot()+
  geom_sf() +
  geom_jitter(data = top_7_butterfly,
           aes(x= long ,y= lat) , size = 2, color="orange")+
  theme_bw() 
```

This is not an exciting map, I only see 7ish dots, not one butterfly travelling south.

Well let's see what we can learn when we plot all of the butterflies from 2021 at the same time. Let's code it by the state level, as opposed to the city level to save time. Getting location at the state level will take `geocode()` 43 seconds instead of 8 minutes so you can start working on the next part while you wait.

```{r}
 butterfly_location_data <- butterfly_dataframes$US_CAN_Recovery_2022 |>
   select(tag_code,city_location,state_province,country, date)|>
   geocode(state = state_province, country = country)


```

We'll want to extract the month from the date column. Make use of `mutate()` to alter the new column called `date` . Use `month()`from the `lubridate` package and set `label=TRUE` as one of its arguments. Also add a column that counts the number of times a state is named in the data.

`{# {r} #  # library(lubridate) # butterfly_location_data_working<- butterfly_location_data |> #   mutate(date = month(date, label = TRUE))`

## Make a Chrolopleth map of the US and Canada.

We would expect locations in the US with more people to have more sightings. So instead of plotting the overal sighting we'll make a Chloropleth map that colors the sightings by state as a percentage of the total sightings.

We have to wrangle the data a bit. In a df called `butterfly_location_summary` We need the following:

-   The total number of sightings per state
-   The total number of sightings in 2022
-   The proportion for each state.

Then we need to join our data frame with `USA_map` to get the location data. I made a states df that has the states names and abbrevitations in it. - join the states df to the butter_location_summary

-   join the new df made above to USA_map, besure to have US map on the left so you don't lose simple features.

```{r}
# Wrangle your data
butterfly_location_summary <- butterfly_location_data |>
   group_by(state_province) |>
   summarise(count_of_sightings = n(),
          total = nrow(x=butterfly_location_data),
          prop = count_of_sightings/total)


# Here is a df with state abreviation and names
states<- as.data.frame(cbind(state.abb, tolower(state.name), state.name))

butterfly_location_data_summary <- inner_join(states, butterfly_location_data_summary, by = c("state.abb" = "state_province"))

# Inner join to get the location data.


USA_map_joined <- USA_map |>
  inner_join(butterfly_location_data_summary, by = c("ID"="V2")) 

```

Great! Let's make our map. Also pick the "YlOrRd" color palette, the default one doesn't conjure up images of Monarchs.

```{r}

USA_map_joined|>
  ggplot()+
  geom_sf(aes(fill=prop)) +
  
  # The code below set a color palette and changes the background color. Orange colors for butterflys and light blue for the background the make the points pop. I also turned off the grid lines. 
  
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +
  theme_minimal() +
  theme(
    panel.background = element_rect(fill = "azure2",
                                colour = "black",
                                size = 0.5),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank())
  

```

The above map doesn't normalize for the population of each state. Notice that Texas, NY, NJ,Virginia, and Ohio are darker because more people live there. to illustrate this run the chunk below of the total number of observations to see that the map is the same.

```{r}
USA_map_joined|>
  ggplot()+
  geom_sf(aes(fill=count_of_sightings)) +
  
  # The code below set a color palette and changes the background color. Orange colors for butterflys and light blue for the background the make the points pop. I also turned off the grid lines. 
  
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +
  theme_minimal() +
  theme(
    panel.background = element_rect(fill = "azure2",
                                colour = "black",
                                size = 0.5),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank())
  
```

I'd like a map that shows the proportion of sightings based on the population of each state. Use the get_acs() function to get the state population for the states (choose geography ="state"). The join with the USA_map_joined to make a normalized proportion by state population.

```{r}
US_pop <- 
  tidycensus::get_acs(
    geography = "state", 
    variables = c(population = "B01003_001"), 
    geometry = FALSE
  ) |>
  mutate(NAME = tolower(NAME))

NEW_DF<- inner_join(USA_map_joined, US_pop, by = c("ID"="NAME"))|>
  mutate(new_prop = count_of_sightings/estimate)

NEW_DF|>
  ggplot()+
  geom_sf(aes(fill=new_prop)) +
  
  # The code below set a color palette and changes the background color. Orange colors for butterflys and light blue for the background the make the points pop. I also turned off the grid lines. 
  
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +
  theme_minimal() +
  theme(
    panel.background = element_rect(fill = "azure2",
                                colour = "black",
                                size = 0.5),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank())
  
```

**Question: What does the above map show?**

Finally these butterflys end up in Mexico for the winter. Using Pre_2023_Mexico_Recovery data

-   filter for 2022 data

-   add a column that is called Mexico and is a list of the word "Mexico"

-   count the number of sightings in each location.

-   Then geocode by state and country.

```{r}
Mexico_locations <- butterfly_dataframes$Pre_2023_Mexico_Recovery |>
  filter(report_season == 2022)|>
  mutate(Mexico = "Mexico") |>
  geocode(state=location, country = Mexico)|>
  st_as_sf(coords = c("x", "y"), crs = 4326)

```

Finally make a point plot to show the location of all the sightings of these butterflies in the US and Mexico. (Hint: You need to make a map of mexico with the maps::map() function). Also this will look better if you take the 8 minutes to geocode by location.

```{r}
butterfly_location_data_8min <- butterfly_dataframes$US_CAN_Recovery_2022 |>
   select(tag_code,city_location,state_province,country, date)|>
   geocode(city = city_location, state = state_province, country = country)
```

```{r}
Mexico_map <-  maps::map(region = "Mexico", plot = FALSE, fill = TRUE) |> st_as_sf(coords = c("x", "y"), crs = 4326)

#install.packages("ggimage")
library(ggimage)

Mexico_locations |>
  mutate(image = "images/monarch-butterfly.png")
  

ggplot(Mexico_locations)+
  #geom_sf(data = NEW_DF) +
  #geom_sf(data = Mexico_map)+
  #geom_image(data = butterfly_location_data_8min, aes(x=long, y=lat) ) +
  geom_image( aes(x=long, y=lat,image=image))
```
